---
title: "99_CD2F_DataViz"
author: "Tristan Caro"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---


# Setup

## Clear the environment

```{r}
rm(list=ls())
```


## Load libraries

```{r}
library(tidyverse)
library(cowplot)
library(latex2exp)
library(ggside)
library(ggsci)
library(ggdist)
```

## Load from cache

```{r}
# Co-registered datasets
co_registered <- read_rds("cache/co_registered.RDS") # Raw
co_registered_fit <- read_rds("cache/co_registered_fitted.RDS") # Fitted
co_registered_summarized <- read_rds("cache/coreg_data_summary.rds") # summarized

# Dilution factor data
dilution_factors <- read_rds("cache/dilution_factors.rds")

# Area data
cd_pc_data <- read_rds("cache/cd_pc_data.RDS")
cd_pc_data_fitted <- read_rds("cache/area_data.RDS")

# Fitted xy data
fit_data <- read_rds("cache/fit_data.RDS")

# Fitting parameter data
fitted_xy_data <- read_rds("cache/peak_data_xy.RDS")

# LOD and LOQ data
LOD_LOQ <- readxl::read_excel("data_output/LOD_LOQ_data.xlsx")


```

## Colors
```{r}
organism_colors <- c("#008c54", "#ffaa00")
```





# Plot

## Co-registered

```{r co-registered_faceted}
p_co_registered <- co_registered %>% 
  filter(!is.na(f_l)) %>% 
  # Plot it!
  ggplot(
    aes(y = at2H_percent_dtc,
        x = cd_pc_corr,
        #color = as.factor(f_l),
        #group = organism.x,
        #label = cell_id
    )
  ) +
  stat_smooth(
    formula = y ~ x,
    #formula = y ~ splines::bs(x, 3),
    linewidth = 1,
    method = 'lm',
    se = TRUE,
    level = .99,
    color = "red"
  ) +
  geom_point(
    alpha = 0.9,
    size = 1
  ) +
  geom_abline(
    slope = 1,
    linetype = "dashed",
    color = "gray",
    alpha = 1,
  ) +
  #facet_wrap(vars(organism.x)) +
  coord_cartesian(
    xlim = c(0,40), 
    ylim = c(0,40)
  ) +
  scale_color_viridis_d(
    end = 0.9,
    option = "magma"
    ) +
  theme_bw() +
  labs(
    y = latex2exp::TeX("$^2F\\%_{nanoSIMS}$"),
    x = latex2exp::TeX("$^2F\\%_{Raman}$"),
    color = latex2exp::TeX("$^2H_2O$ Label Strength $^2F\\%$"),
    shape = ""
  ) +
  theme(
    legend.position = "bottom"
  )
p_co_registered
```


```{r linear model}
co_reg_fit <- broom::tidy(lm(data = co_registered, cd_pc_corr  ~ at2H_percent_dtc))

print_lm_summary <- function(df) {
  paste0("y = ", round(df$estimate[2], 2), "x + ", round(df$estimate[1], 2))
}

print_lm_summary(co_reg_fit)

co_reg_fit_thy <- broom::tidy(
  lm(data = co_registered %>%
       filter(
         organism.x == "T. hydrogeniphilus"
        ), 
     cd_pc_corr  ~ at2H_percent_dtc)
  )

co_reg_fit_mb <- broom::tidy(
  lm(data = co_registered %>%
       filter(
         organism.x == "M. NSHQ14"
        ), 
     cd_pc_corr  ~ at2H_percent_dtc)
  )

print_lm_summary(co_reg_fit_thy)
print_lm_summary(co_reg_fit_mb)
```


```{r co-registered-combined}
p_co_registered2 <- co_registered %>% 
  filter(!is.na(f_l)) %>% 
  # Plot it!
  ggplot(
    aes(x = at2H_percent_dtc,
        y = cd_pc_corr,
        label = cell_id,
    )
  ) +
  geom_point(
    aes(
      color = as.factor(f_l),
      #shape = organism.x
      ),
    alpha = 9,
    size = 3
  ) +
  geom_abline(
    slope = 1,
    linetype = "dashed",
    color = "gray",
    alpha = 1,
  ) +
  stat_smooth(
    formula = y ~ x,
    #formula = y ~ splines::bs(x, 3),
    size = 0.5,
    method = 'lm',
    se = TRUE,
    color = "red"
  ) +
  coord_cartesian(
    xlim = c(0,40), 
    ylim = c(0,40)
  ) +
  scale_color_viridis_d(
    end = 0.9,
    option = "magma"
    ) +
  theme_bw() +
  labs(
    x = latex2exp::TeX("$^2F\\%_{nanoSIMS}$"),
    y = latex2exp::TeX("$^2F\\%_{Raman}$"),
    color = "Label Strength (% D2O)"
  ) +
  theme(
    legend.position = c(0.8, 0.25),
    legend.background = element_rect(color = "black"),
    legend.title = element_text(size = 10)
  )
p_co_registered2
```



## CD + 2Fbc ~ FL

This plot represents 2F calculated by CD%, 2F calculated by back-calculating true nanoSIMS values using dilution factors (DF), plotted against label strength (FL)

```{r}
co_registered_summarized_mini <- co_registered_summarized |> 
  select(f_l, mean_cdpc, sd_cdpc, n)

dilution_factors_mini <- dilution_factors |> 
  select(f_l, F_before_backcalc, sF_before_backcalc)

co_registered_summarized_mini |> 
  left_join(dilution_factors_mini, by = "f_l") |> 
  filter(f_l != 0) |>
  pivot_longer(cols = c(mean_cdpc, F_before_backcalc), 
            names_to = "method", 
            values_to = "2F"
            ) |> 
  pivot_longer(
    cols = c(sd_cdpc, sF_before_backcalc),
    names_to = "error_type",
    values_to = "SD"
  ) |> 
  ggplot(
    aes(x = f_l,
        y = `2F`,
        color = method)
  ) +
  geom_point() +
  geom_pointrange(
    aes(ymin = `2F` - SD,
        ymax = `2F` + SD,
        color = error_type)
  ) +
  facet_wrap(vars(error_type)) +
  theme_bw()
  
```


## CD FL


```{r}
calculate_lm_from_coreg_CD <- function(dataset, organism_choice) {
  return(
    broom::tidy(
  lm(
    data = dataset %>% 
      # filter out f_L 40 and 50 for the model
      filter(f_l < 40, organism == organism_choice),
    `CD%`  ~ f_l
    )
  ) |> 
    # Add organism info
    mutate(organism = organism_choice) |> 
    select(term, estimate, organism) |> 
    pivot_wider(names_from = term, values_from = estimate) |> 
    mutate(
       # determine sign for y intercept
      sign = ifelse(`(Intercept)` < 0, "-", "+"),
      # print out the equation for the line
      equation = sprintf("y = %.2fx %s %.2f", f_l, sign, abs(`(Intercept)`))
    )
  )
}

cdfl_model_thy <- calculate_lm_from_coreg_CD(
  dataset = co_registered_fit, 
  organism_choice = "T. hydrogeniphilus")

cdfl_model_mb <- calculate_lm_from_coreg_CD(
  dataset = co_registered_fit,
  organism_choice = "M. NSHQ14"
)


p_cd_fl <- co_registered_summarized %>% 
  filter(!is.na(f_l)) %>% 
  ggplot(
    aes(
      x = f_l,
      y = mean_cdpc
      )
  ) +
  # 1:1 line
  geom_abline(
    slope = 1,
    linetype = "dotted",
    color = "gray",
    alpha = 1,
  ) +
  # LOD
  # geom_hline(
  #   yintercept = pull(select(LOD_LOQ, LOD_CD_percent)),
  #   color = "red",
  #   linetype = "dashed",
  #   linewidth = 0.25
  #     ) +
  # # LOQ
  # geom_hline(
  #   yintercept = pull(select(LOD_LOQ, LOQ_CD_percent)),
  #   color = "orange",
  #   linetype = "dashed",
  #   linewidth = 0.25
  #     ) +
  # T. hy linear fit
  geom_abline(
    data = cdfl_model_thy,
    aes(
      slope = f_l,
      intercept = `(Intercept)`
    ),
    color = "#346beb",
    linetype = "dashed"
  ) +
  # Mb linear fit
  geom_abline(
    data = cdfl_model_mb,
    aes(
      slope = f_l,
      intercept = `(Intercept)`
    ),
    color = "#346beb",
    linetype = "dashed"
  ) +
  geom_point(size = 2) +
  geom_pointinterval(
    aes(
      ymin = mean_cdpc - sd_cdpc,
      ymax = mean_cdpc + sd_cdpc
    )
  ) +
  # Mb equation
  geom_label(
    data = cdfl_model_mb,
    x = 42, 
    y = 1,
    color = "blue",
    aes(
      label = equation
      )
  ) +
  # Thy equation
   geom_label(
    data = cdfl_model_thy,
    x = 42, 
    y = 1,
    color = "blue",
    aes(
      label = equation
      )
  ) +
  facet_wrap(vars(organism), scales = "free") +
  scale_color_manual(values = organism_colors) + 
  scale_x_continuous(
    limits = c(0, 55),
    breaks = c(0, 10, 20, 30, 40, 50)
    ) +
  scale_y_continuous(
    limits = c(0, 55),
    breaks = c(0, 10, 20, 30, 40, 50)
  ) +
  theme_classic() +
  labs(
    x = latex2exp::TeX("Tracer Strength $^2F$ (at. %)"),
    y = latex2exp::TeX("Biomass Enrichment $^2F$ (at. %)")
  ) +
  theme(
    legend.position = "NA",
    strip.background = element_blank()
  )
p_cd_fl

# cowplot::save_plot(
#   plot = p_cd_fl,
#   filename = "fig_output/cd_fl.pdf",
#   base_height = 4,
#   base_width = 8
# )
```

## 2F FL

```{r}
# Define a function to calculate linear models for 2F
calculate_lm_from_coreg_2F <- function(dataset, organism_choice) {
  return(
    broom::tidy(
  lm(
    data = dataset %>% 
      # filter out f_L 40 and 50 for the model
      filter(f_l < 40, organism == organism_choice),
    at2H_percent_dtc  ~ f_l
    )
  ) |> 
    # Add organism info
    mutate(organism = organism_choice) |> 
    select(term, estimate, organism) |> 
    pivot_wider(names_from = term, values_from = estimate) |> 
    mutate(
       # determine sign for y intercept
      sign = ifelse(`(Intercept)` < 0, "-", "+"),
      # print out the equation for the line
      equation = sprintf("y = %.2fx %s %.2f", f_l, sign, abs(`(Intercept)`))
    )
  )
}


# Calculate linear models of nanoSIMS data using function defined above
nanofl_model_thy <- calculate_lm_from_coreg_2F(
  dataset = co_registered_fit, 
  organism_choice = "T. hydrogeniphilus")

nanofl_model_mb <- calculate_lm_from_coreg_2F(
  dataset = co_registered_fit,
  organism_choice = "M. NSHQ14"
)


# Plot it
p_2f_fl <- co_registered_summarized %>% 
  filter(!is.na(f_l)) %>% 
  ggplot(
    aes(
      x = f_l,
      y = mean_2F
      )
  ) +
  # 1:1 line
  geom_abline(
    slope = 1,
    linetype = "dotted",
    color = "gray",
    alpha = 1,
  ) +
  # LOD
  # geom_hline(
  #   yintercept = pull(select(LOD_LOQ, LOD_CD_percent)),
  #   color = "red",
  #   linetype = "dashed",
  #   linewidth = 0.25
  #     ) +
  # # LOQ
  # geom_hline(
  #   yintercept = pull(select(LOD_LOQ, LOQ_CD_percent)),
  #   color = "orange",
  #   linetype = "dashed",
  #   linewidth = 0.25
  #     ) +
  # T. hy linear fit
  geom_abline(
    data = nanofl_model_thy,
    aes(
      slope = f_l,
      intercept = `(Intercept)`
    ),
    color = "#346beb",
    linetype = "dashed"
  ) +
  # Mb linear fit
  geom_abline(
    data = nanofl_model_mb,
    aes(
      slope = f_l,
      intercept = `(Intercept)`
    ),
    color = "#346beb",
    linetype = "dashed"
  ) +
  geom_point(size = 2.5) +
  geom_pointinterval(
    aes(
      ymin = mean_2F - sd_2F,
      ymax = mean_2F + sd_2F
    )
  ) +
  # Mb equation
  geom_label(
    data = nanofl_model_mb,
    x = 42, 
    y = 1,
    color = "blue",
    aes(
      label = equation
      )
  ) +
  # Thy equation
   geom_label(
    data = nanofl_model_thy,
    x = 42, 
    y = 1,
    color = "blue",
    aes(
      label = equation
      )
  ) +
  facet_wrap(vars(organism), scales = "free") +
  scale_color_manual(values = organism_colors) + 
  scale_x_continuous(
    limits = c(0, 55),
    breaks = c(0, 10, 20, 30, 40, 50)
    ) +
  scale_y_continuous(
    limits = c(0, 55),
    breaks = c(0, 10, 20, 30, 40, 50)
  ) +
  theme_classic() +
  labs(
    x = latex2exp::TeX("Tracer Strength $^2F$ (at. %)"),
    y = latex2exp::TeX("Biomass Enrichment $^2F$ (at. %)")
  ) +
  theme(
    legend.position = "NA",
    strip.background = element_blank()
  )
p_2f_fl
```

## Cowplot: CD-FL and 2F-FL

```{r}
figure_1 <- cowplot::plot_grid(
  p_cd_fl,
  p_2f_fl,
  ncol = 1
)

cowplot::save_plot(
  filename = "fig_output/figure1.pdf",
  figure_1,
  base_height = 6,
  base_width = 6
)
```

## 2R FL

```{r}
co_registered %>% 
  filter(!is.na(f_l)) %>% 
  ggplot(
    aes(x = as.factor(f_l),
        y = `Ratio_2Hx1H`,
        color = organism.x
        )
  ) +
  facet_wrap(vars(organism.x)) +
  geom_point(
    alpha = 0.25
  ) +
  scale_color_manual(values = organism_colors) + 
  labs(
    x = latex2exp::TeX("$^2F$ Growth Water"),
    y = latex2exp::TeX("$^2R_{nanoSIMS}$")
  ) +
  theme_classic() +
  theme(
    legend.position = "NA",
    strip.background = element_blank()
  )
  
```


## Raman spectrum

```{r}
cd_pc_data %>% filter(cell_id == "Mb_50_18_38") %>% 
  ggplot(aes(
    x = wavenumber_cm,
    y = intensity
  )) +
  geom_line() +
  theme_minimal()
```


## Compare fitted co-reg with raw data

### Compare the co-registered datasets

```{r}
co_reg_compare <- bind_rows(
  co_registered %>% select(at2H_percent_dtc, cd_pc, f_l, organism.x) %>% mutate(type = "raw", organism = organism.x),
  co_registered_fit %>% select(at2H_percent_dtc, `CD%`, f_l, organism) %>% mutate(type = "fitted")
) %>%
  mutate(cd_percent = case_when(
    is.na(cd_pc) ~ `CD%`,
    is.na(`CD%`) ~ cd_pc
  )) %>% 
  select(-c(cd_pc, `CD%`, organism.x))
```

```{r}
co_reg_compare %>% 
  ggplot(
    aes(
      x = at2H_percent_dtc,
      y = cd_percent,
      color = type
    )
  ) +
  geom_point(
    alpha = 0.5
  ) +
  geom_smooth(
    method = "lm",
    formula = "y ~ x"
  ) +
  geom_abline(
    slope = 1,
    linetype = "dashed",
    color = "gray",
    alpha = 1,
  ) +
  facet_wrap(vars(type)) +
  coord_cartesian(
    xlim = c(0,50), 
    ylim = c(0,50)
  ) +
  scale_color_viridis_d(
    end = 0.7,
    begin = 0.3,
    option = "magma"
    ) +
  theme_bw() +
  labs(
    x = latex2exp::TeX("$^2F\\%_{nanoSIMS}$"),
    y = latex2exp::TeX("$^2F\\%_{Raman}$"),
    color = latex2exp::TeX("$^2H_2O$ Label Strength $^2F\\%$")
  ) +
  theme(
    legend.position = "bottom"
  )
```

### CD_FL jitter plot

```{r}
p_cd_fl1 <- co_registered %>% 
  filter(!is.na(f_l)) %>% 
  ggplot(
    aes(x = f_l,
        y = cd_pc_corr,
        color = organism.x
        )
  ) +
  labs(
    x = latex2exp::TeX("$^2F$ Growth Water"),
    y = latex2exp::TeX("$^2F_{Raman}$"),
    title = "Raw Data"
  ) +
  facet_wrap(
    vars(organism.x), 
    scales = "free") +
  geom_abline(
    slope = 1,
    linetype = "dashed",
    color = "gray",
    alpha = 1,
  ) +
  geom_point(
    alpha = 0.5,
    position = position_jitter(width = 2)
  ) +
  ggdist::stat_pointinterval(
    position = position_nudge(x = 0.2),
    color = "black"
  ) +
  scale_color_manual(values = organism_colors) + 
  scale_x_continuous(
    limits = c(0, 55),
    breaks = c(0, 10, 20, 30, 40, 50)
    ) +
  scale_y_continuous(
    limits = c(0, 55),
    breaks = c(0, 10, 20, 30, 40, 50)
  ) +
  theme_classic() +
  theme(
    legend.position = "NA",
    strip.background = element_blank()
  )

p_cd_fl2 <- co_registered_fit %>% 
  filter(!is.na(f_l)) %>% 
  ggplot(
    aes(x = f_l,
        y = `CD%`,
        color = organism
        )
  ) +
  labs(
    x = latex2exp::TeX("$^2F$ Growth Water"),
    y = latex2exp::TeX("$^2F_{Raman}$"),
    title = "Fitted Data"
  ) +
  facet_wrap(
    vars(organism), 
    scales = "free") +
  geom_abline(
    slope = 1,
    linetype = "dashed",
    color = "gray",
    alpha = 1,
  ) +
  geom_point(
    alpha = 0.5,
    position = position_jitter(width = 2),
  ) +
  ggdist::stat_pointinterval(
    position = position_nudge(x = 0.2),
    color = "black"
  ) +
  scale_color_manual(values = organism_colors) + 
  scale_x_continuous(
    limits = c(0, 55),
    breaks = c(0, 10, 20, 30, 40, 50)
    ) +
  scale_y_continuous(
    limits = c(0, 55),
    breaks = c(0, 10, 20, 30, 40, 50)
  ) +
  theme_classic() +
  theme(
    legend.position = "NA",
    strip.background = element_blank()
  )

co_reg_compared <- cowplot::plot_grid(
  p_cd_fl1,
  p_cd_fl2,
  ncol = 1
)
co_reg_compared

save_plot(
  filename = "fig_output/co_reg_compare.pdf",
  plot = co_reg_compared,
  base_height = 8,
  base_width = 8
  )


```

### CD_FL boxplot comparison

```{r}
co_reg_compare %>% 
  filter(!is.na(f_l)) %>% 
  ggplot(
    aes(
      x = as.factor(f_l),
      y = cd_percent,
      color = type
    )
  ) +
  ggdist::stat_dist_pointinterval(position = position_dodgejust(width = 0.5)) +
  scale_color_manual(values = c("black", "red")) +
  labs(
    x = latex2exp::TeX("$^2H_2O$ Label Strength $^2F\\%$"),
    y = latex2exp::TeX("$^2F\\%_{Raman}$"),
    color = "Data Source"
  ) +
  theme_classic()
```


# Fitting parameter data
```{r}
p_fit_thy <- fit_data %>% 
  mutate(organism =
    case_when(
      str_detect(sample, "Thy") ~ "T. hydrogeniphilus",
      str_detect(sample, "Mb") ~ "M. NSHQ14"
      )
  ) %>% 
  pivot_longer(
    cols = -c(fit, sample, organism),
    names_to = "fit_param",
    values_to = "value"
  ) %>%
  filter(organism == "T. hydrogeniphilus") %>% 
  ggplot(
    aes(x = value,
        fill = organism)
  ) +
  geom_histogram(
    bins = 100,
    alpha = 0.5,
    fill = "orange"
    ) +
  facet_wrap(vars(fit_param, fit), scales = "free") +
  theme_bw()

p_fit_mb <- fit_data %>% 
  mutate(organism =
    case_when(
      str_detect(sample, "Thy") ~ "T. hydrogeniphilus",
      str_detect(sample, "Mb") ~ "M. NSHQ14"
      )
  ) %>% 
  pivot_longer(
    cols = -c(fit, sample, organism),
    names_to = "fit_param",
    values_to = "value"
  ) %>%
  filter(organism == "M. NSHQ14") %>% 
  ggplot(
    aes(x = value,
        fill = organism)
  ) +
  geom_histogram(
    bins = 100,
    alpha = 0.5,
    fill = "green"
    ) +
  facet_wrap(vars(fit_param,fit ), scales = "free") +
  theme_bw()

cowplot::plot_grid(p_fit_thy, p_fit_mb)
```

