---
title: "01_Raman_Data_Reduction"
author: "Tristan Caro"
date: "`r Sys.Date()`"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Setup

## Clear the environment

```{r}
rm(list=ls())
```


## Load Libraries

```{r}
require(tidyverse)
require(ggdist)
require(latex2exp)
```

## Load Source

```{r}
source(file = "source/read_raman_file.R")
source(file = "source/plot_raman.R")
source(file = "source/calculate_CD.R")
```

## Load cell metadata

```{r}
cell_metadata <- readxl::read_excel("data/other/cell_metadata.xlsx") %>% 
  select(-c(description))
```

## Load used conditions

```{r}
used_conditions <- readxl::read_excel("data/other/used_conditions.xlsx") %>% 
  pull(condition)
```


## Load Raman data from .txt

```{r, message = FALSE}
# Prepare list of Raman files
txt_file_list = list.files(
  path = "data/Raman/txt_files",
  pattern = "*.txt"
  )

raman_data <- tibble()
raman_data <- raman_data[-1,]


# Read in all Raman files (this will take a moment)
i = 0
for (txt in txt_file_list) {
  txt_file_len <- length(txt_file_list)
  temp <- read_raman_file(paste0("data/Raman/txt_files/", txt))
  temp <- temp %>% mutate(directory = txt)
  raman_data <- bind_rows(raman_data, temp)
  i <- i + 1
  print(paste0("File ", i, " out of ", txt_file_len, " loaded."))
}

# Create a cache of the raw data
saveRDS(raman_data, file = "cache/raman_data_raw.RDS")
```

## Assign crude metadata

### Add in the raman_spectrum_id

```{r}
raman_data_cleaned <- raman_data %>% 
  mutate(raman_spectrum_id = str_remove(directory, ".txt"))
```

### Join the two tables

```{r}
raman_data_cleaned_w_mtda <- raman_data_cleaned %>% 
  left_join(cell_metadata, by = "raman_spectrum_id")
```
  
### Add in some metadata

```{r}
raman_cell_data <- raman_data_cleaned_w_mtda %>% 
  # Remove raman data that does not have a `cell_id`
  # i.e. spectra that were not "kept" due to acquisition issue or retrys
  filter(!is.na(cell_id)) %>% 
  # Parse to find organism
  mutate(organism = 
           case_when(
             str_detect(cell_id, "Mb_") ~ "Mb",
             str_detect(cell_id, "Mbcal_") ~ "Mbcal",
             str_detect(cell_id, "Thy_") ~ "Thy"
           )) %>% 
  # Add cell numbers
  mutate(sample = str_sub(cell_id, end = -4),
         cell_number_str = str_sub(cell_id, start = -2),
         cell_number = as.numeric(cell_number_str),
         f_l = case_when(sample == "Mb_40_y" ~ 40,
                         TRUE ~ as.numeric(
                           str_sub(
                             cell_id, 
                             start = -8, 
                             end = -7)
                           )
                         )
         ) %>% 
  # Parse to find label strengths
  # Re-order columns for readability
  select(
    sample,
    organism,
    f_l,
    cell_id,
    cell_number,
    cell_number_str,
    raman_spectrum_id,
    nanoSIMS_file_id,
    nanoSIMS_roi_number,
    wavenumber_cm,
    intensity,
    band
  )
```


```{r}
cd_pc_data <- raman_cell_data %>% 
  ungroup() %>% 
  group_by(cell_id, band) %>%
  mutate(area = sum(intensity)) %>% 
  ungroup()
```

```{r}
saveRDS(cd_pc_data, file = "cache/cd_pc_data.RDS")
```

# Summarize

```{r}
cd_pc_data_summarized <- cd_pc_data %>% 
  select(sample, organism, cell_id, band, f_l, area) %>% 
  unique() %>% 
  filter(!is.na(band)) %>%
  group_by(cell_id) %>%
  pivot_wider(
    names_from = band,
    values_from = area
  ) %>% 
  mutate(
    cd_frac = CD / (CH + CD),
    cd_pc = cd_frac * 100)
 

```

```{r}
cd_pc_data_summarized %>% 
  filter(organism != "Mbcal") %>% 
  filter(sample != "Mb_40_24") %>% 
  filter(sample != "Mb_20_23") %>% 
  ggplot(
    aes(
      x = f_l,
      y = cd_pc,
      color = organism,
      fill = organism,
      group = f_l
    )
  ) +
  geom_point() +
  facet_wrap(vars(organism)) +
  geom_smooth(method = "lm")
```

